<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–°–æ–±–∏—Ä–∞—Ç–µ–ª—å –≥–µ—Ä–æ–µ–≤</title>
  <link href="assets/collector/styles.css" rel="stylesheet">
  <script src="assets/lib/uuidv1.min.js"></script>
  <script src="assets/lib/vue3.js"></script>
  <script src="assets/lib/d3@7.js"></script>
  <script src="assets/lib/telegram.js"></script>
</head>
<body>

  <header>
    <h1>–°–æ–±–∏—Ä–∞—Ç–µ–ª—å –≥–µ—Ä–æ–µ–≤</h1>
    <p>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–±–æ—Ä–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥–µ—Ä–æ—è—Ö —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –≤–æ–µ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏&nbsp;Z –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –Ω–µ–π –ª—é–±–æ–º—É –∂–µ–ª–∞—é—â–µ–º—É. –†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –≤ <a href="heroes-list/heroes-list.json" target="_blank">heroes-list/heroes-list.json</a></p>
  </header>

  <p>–§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:</p>

  <ul>
    <li>–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Ä–∞–±–æ—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö &mdash; –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, C–∞–π—Ç –ú–∏–Ω–æ–±–æ—Ä–æ–Ω—ã z.mil.ru, –¢–µ–ª–µ–≥—Ä–∞–º –∫–∞–Ω–∞–ª "–†–∞–±–æ—Ç–∞–µ–º, –±—Ä–∞—Ç!", –°–∞–π—Ç warheroes, –í–∏–∫–∏–ø–µ–¥–∏—è/Megabook, –∏ —Ç.–¥.) –≤ <strong>data/resource/*</strong></li>
    <li>–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏ –≤ <strong>heroes-list/heroes-list.json</strong> —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏ –≤ <strong>heroes-list/images/*</strong>.</li>
  </ul>

  <main id="app">
    <component-selector :tabs="resource.tabs" v-model="resource.current"></component-selector>

    <keep-alive>
      <component
        :is="currentResourceComponent"
        :resource-key="resource.current"
        :all-resources-keys="allResourcesKeys"
        :heroes-list="heroesList"
        :channel="currentResourceChannel"
        :channel-title="currentResourceChannelTitle"
        @create-hero="createHero"
        @update-heroes="updateHeroes"
      ></component>
    </keep-alive>

    <component-modals :modals="modals" @close="closeModal"></component-modals>
  </main>

  <script type="module">
    import deepmerge from './assets/lib/deepmerge.js';
    import { getJsonDocument, saveJsonDocument } from './assets/collector/utils.resource.js';
    import ComponentSelector from './assets/collector/component.selector.js';
    import ComponentModals from './assets/collector/component.modals.js';

    import ComponentResourceZmil from './assets/collector/component.resource.zmil.js';
    import ComponentResourceZmilNew from './assets/collector/component.resource.zmil-new.js';
    import ComponentResourceWarheroes from './assets/collector/component.resource.warheroes.js';
    import ComponentResourceTsargrad from './assets/collector/component.resource.tsargrad.js';
    import ComponentResourceKontingent from './assets/collector/component.resource.kontingent.js';
    import ComponentResourceTelegram from './assets/collector/component.resource.telegram.js';

    import ComponentResourceHeroes from './assets/collector/component.resource.heroes.js';
    import ComponentResourceBriefings from './assets/collector/component.resource.briefings.js';
    import ComponentResourceAwards from './assets/collector/component.resource.awards.js';
    import MixinHeroList from './assets/collector/mixin.common-hero-list.js';

    const app = Vue.createApp({
      components: {
        ComponentSelector,
        ComponentModals,
        ComponentResourceZmil,
        ComponentResourceZmilNew,
        ComponentResourceWarheroes,
        ComponentResourceTsargrad,
        ComponentResourceKontingent,
        ComponentResourceTelegram,
        ComponentResourceHeroes,
        ComponentResourceBriefings,
        ComponentResourceAwards,
      },
      mixins: [MixinHeroList],
      data () {
        return {
          resource: {
            tabs: [
              { key: 'zmil', label: '–ì–µ—Ä–æ–∏ Z', sublabel: 'z.mil.ru' },
              { key: 'zmil-new', label: '–ì–µ—Ä–æ–∏ Z (2)', sublabel: 'z.mil.ru' },
              { key: 'warheroes', label: '–ì–µ—Ä–æ–∏ –†–æ—Å—Å–∏–∏', sublabel: 'warheroes.ru' },
              { key: 'tsargrad', label: '–ù–∞—à–∏ –≥–µ—Ä–æ–∏', sublabel: 'ug.tsargrad.tv' },
              { key: 'kontingent', label: '–ì–µ—Ä–æ–∏ Z', sublabel: 'kontingent.press' },
              { key: 'telegram.rabotaembrat', label: '–†–∞–±–æ—Ç–∞–µ–º, –ë—Ä–∞—Ç! üá∑üá∫', sublabel: '@rabotaembrat' },
              { key: 'telegram.zakharprilepin', label: '–ó–∞—Ö–∞—Ä –ü—Ä–∏–ª–µ–ø–∏–Ω', sublabel: '@zakharprilepin' },
              { key: 'telegram.mod_russia', label: '–ú–∏–Ω–æ–±–æ—Ä–æ–Ω—ã –†–æ—Å—Å–∏–∏', sublabel: '@mod_russia' },

              { key: 'briefings', label: '–ë—Ä–∏—Ñ–∏–Ω–≥–∏', sublabel: 'z.mil.ru', notHeroResource: true, group: 'right' },
              // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ
              { key: 'awards', label: '–ù–∞–≥—Ä–∞–¥—ã', sublabel: 'wikipedia.org', group: 'right' },
              { key: 'heroes', label: '–ü—Ä–æ–≤–µ—Ä–∫–∞', sublabel: 'heroes-list.json', notHeroResource: true, group: 'right' }
            ],
            current: location.hash.replace('#', '') || 'zmil'
          },
          // heroes: {},
          heroesList: [],
          modals: [],
        };
      },
      provide () {
        return {
          confirm: this.openConfirm,
          input: this.openInput
        };
      },
      watch: {
        'resource.current' (value) {
          location.hash = value;
        },
      },
      computed: {
        currentResourceComponent () {
          return `component-resource-${this.resource.current.split(/\./)[0]}`;
        },
        currentResourceChannel () {
          return this.resource.current.split(/\./)[1];
        },
        currentResourceChannelTitle () {
          return this.resource.tabs.find(tab => this.resource.current === tab.key).label;
        },
        allResourcesKeys () {
          return this.resource.tabs.filter(tab => !tab.notHeroResource).map(tab => tab.key);
        }
      },
      async created () {
        await this.getHeroes();
      },
      methods: {
        async getHeroes () {
          this.heroesList = await getJsonDocument('heroes-list/heroes-list.json');
        },
        async saveHeroes () {
          await saveJsonDocument('heroes-list/heroes-list.json', this.heroesList);
        },
        async createHero (name) {
          // –ï—Å–ª–∏ –ø–æ–¥–æ–±–Ω–æ–µ –∏–º—è —É–∂–µ –µ—Å—Ç—å, –º—ã –¥–æ–ª–∂–Ω—ã —Ä–µ—à–∏—Ç—å
          // –æ—Ç–º–µ–Ω–∏—Ç—å –ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –≤—Å–µ-—Ç–∞–∫–∏ —Å–æ–∑–¥–∞—Ç—å –æ–¥–Ω–æ—Ñ–∞–º–∏–ª—å—Ü–∞.
          // –û–Ω, –≤–ø—Ä–æ—á–µ–º, –¥–æ–ª–∂–µ–Ω –±—ã –≤ –∏—Ç–æ–≥–µ –∫–∞–∫-—Ç–æ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è...
          // –ú—ã, –∑–Ω–∞—á–∏—Ç, –¥–æ–ª–∂–Ω—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –æ–ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
          // –æ–± —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –≥–µ—Ä–æ–µ, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ—à–∏–ª, —Ç–æ—Ç –∂–µ
          // —ç—Ç–æ –∏–ª–∏ –Ω–µ—Ç.
          // const heroes = this.getHeroes({ name });
          // const confirmed = !heroes.length || await this.openConfirm({
          //   header: '–¢–∞–∫–æ–µ –∏–º—è —É–∂–µ –µ—Å—Ç—å'
          //   body: heroes.map(hero => {
          //     const links = ['zmil', 'warheroes', 'tsargrad', 'kontingent']
          //       .map(src => {
          //         return hero[src]?.url
          //           ? `<a href="${hero[src]?.url}" target="_blank">${hero[src]?.url}</a>`
          //           : '';
          //       }).filter(item => item);
          //     return `<p>${hero.name}, ${hero.rank}, ${links.join(', ')}</p>`;
          //   });
          // });

          // if (confirmed) {
          //   this.heroesList.push({ name })
          // }
          // await this.saveHeroes();
          console.log('create hero', name);
        },
        async updateHeroes (update) {
          update.list.forEach((hero, i) => {
            const heroIndex = this.getHeroIndexById(
              update.ids ? update.ids[i] : this.getHeroId(hero)
            );
            if (heroIndex > -1) {
              this.heroesList[heroIndex] = deepmerge(this.heroesList[heroIndex], hero, {
                arrayMerge: (target, source) => source
              });
            } else {
              this.heroesList.push(hero);
              console.warn('–ù–æ–≤—ã–π –≥–µ—Ä–æ–π –¥–æ–±–∞–≤–ª–µ–Ω:', hero);
            }
          });
          await this.saveHeroes();
        },

        // Modals

        async openConfirm ({ body, header } = {}) {
          return this.openModal({ type: 'confirm', body, header });
        },
        async openInput ({ header } = {}) {
          return this.openModal({ type: 'input', header });
        },
        async openModal ({ type, body, header } = {}) {
          return new Promise((resolve, reject) => {
            this.modals.push({ type, body, header, resolve, reject });
          });
        },
        closeModal () {
          this.modals.pop();
        },
      }
    }).mount('#app');
  </script>


  <!-- –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏ -->
  <script>
    window.COHGetHeroesList = async function () {
      return await fetch('heroes-list/heroes-list.json').then(result => result.json());
    }

    window.COHFilterByResource = async function (resource) {
      const list = await COHGetHeroesList();
      return list.filter(hero => hero.resources[resource]);
    }

    window.COHFilterByCallback = async function (callback = h => h) {
      const list = await COHGetHeroesList();
      return list.filter(callback);
    }
  </script>

</body>
</html>